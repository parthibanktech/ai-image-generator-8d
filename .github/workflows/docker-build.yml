# GitHub Actions Workflow: Automatically build and push Docker images to Docker Hub
# This runs whenever you push code to main/master branch or create a pull request

name: Build and Push Docker Image

# When to run this workflow
on:
  push:
    branches: [ main, master ]  # Run on push to main or master branch
  pull_request:
    branches: [ main, master ]  # Run on pull requests to main or master
  workflow_dispatch:             # Allow manual trigger from GitHub Actions tab

# Environment variables used throughout the workflow
env:
  REGISTRY: docker.io  # Docker Hub registry
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/ai-image-generator  # Your Docker Hub image name

jobs:
  build-and-push:
    runs-on: ubuntu-latest  # Use Ubuntu Linux runner
    permissions:
      contents: read        # Permission to read repository contents
      packages: write       # Permission to push to Docker Hub

    steps:
      # Step 1: Get the code from your repository
      - name: Checkout repository
        uses: actions/checkout@v4
        # This downloads your code so the workflow can build it

      # Step 2: Set up Docker Buildx (advanced Docker builder)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        # Buildx enables faster builds and multi-platform support

      # Step 3: Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # Your Docker Hub username (from GitHub Secrets)
          password: ${{ secrets.DOCKERHUB_TOKEN }}     # Your Docker Hub token (from GitHub Secrets)
        # This authenticates with Docker Hub so we can push images

      # Step 4: Generate tags and labels for the Docker image
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch          # Tag with branch name (e.g., main)
            type=ref,event=pr              # Tag with PR number (e.g., pr-123)
            type=semver,pattern={{version}} # Tag with version if using semantic versioning
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}  # Tag as 'latest' if on main/master
        # This creates proper tags like 'latest', 'main', etc.

      # Step 5: Build the Docker image and push to Docker Hub
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .              # Build from current directory
          push: true              # Push to Docker Hub (set to false for testing)
          tags: ${{ steps.meta.outputs.tags }}      # Use tags from step 4
          labels: ${{ steps.meta.outputs.labels }}  # Add metadata labels
          no-cache: true          # Disable cache to force fresh build
        # This builds your Dockerfile and pushes the image to YOUR_USERNAME/ai-image-generator

      # Step 6: Display the image digest (unique identifier)
      - name: Image digest
        run: echo ${{ steps.meta.outputs.digest }}
        # This shows the SHA256 digest of the built image for verification

# What happens after this workflow runs:
# 1. Your code is built into a Docker image
# 2. The image is pushed to: docker.io/YOUR_USERNAME/ai-image-generator
# 3. You can pull it with: docker pull YOUR_USERNAME/ai-image-generator:latest
# 4. Anyone can deploy your app using this image!

# Required GitHub Secrets (add these in your repo settings):
# - DOCKERHUB_USERNAME: Your Docker Hub username (e.g., parthibanktech3)
# - DOCKERHUB_TOKEN: Your Docker Hub access token (get from https://hub.docker.com/settings/security)
